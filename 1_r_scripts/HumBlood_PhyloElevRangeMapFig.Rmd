---
title: "HumBlood - Phylo Elev Range Map Fig"
author: "Jessie Williamson"
date: "12/1/2020; last revised 1/22/22"
output: html_document
---

Script to produce our sampling locality map and figure components associated with Figure 1, the 'phylo elev range map fig'. Note that all spatial data were wrangled and processed in HumBlood_DataWrangling.Rmd - this script includes only the code to load in those data and produce the map. 

This script also produces basic components of this figure, which were then read out and processed in Adobe Illustrator for more creative license. See annotations below for where 'final' R components were then manipulated in Illustrator. 

This script can be run after running HumBlood_DataWrangling.Rmd OR as a standalone. 


# Set up directory structure with here() 
```{R, message=FALSE, warning=FALSE}
# rm(list=ls(all=TRUE)) # clear workspace 
# setwd("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood")
here::here() # This will enable me to build a path to top level of my project file every time I use it. 
```
Nice info about why setwd() can be really problematic: https://github.com/jennybc/here_here#readme
More on benefits of 'here()' here: http://jenrichmond.rbind.io/post/how-to-use-the-here-package/


# Load packages
```{R, message=FALSE, warning=FALSE}
library(reshape)
library(reshape2)
library(plyr)
library(dplyr)
library(car)
library(GGally)
library(Hmisc)
library(gridExtra)
library(stats)
library(gplots)
library(ggplot2)
library(stats4) # Forces knitr to work when it's being wonky
library(PMCMR) #Allows Kruskal-Wallis post-hocs
library(effects)
library(gridExtra)
library(lattice)
library(survival)
library(fmsb)
library(faraway)
library(ape)
library(tidyr)
library(rcompanion)
library(here)
library(cowplot)

# Mapping 
library(raster)
library(sp)
library(rgdal)
library(RStoolbox)
library(prettymapr)
library(viridis)
library(rasterVis)
```


# Load in data to use for map 
```{r}
# Final hummingbird blood dataset
# Don't need to load if already loaded from another script 
final <- read.csv("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/AllHummingbirdBlood_Wrangled_withBioClim_andPCA_03-01-21.csv", stringsAsFactors = TRUE)
final <- final[ , !(colnames(final) %in% c("X"))] # drop weird X column 1 if reading in from read.csv
names(final)[names(final) == "b13b83.genotype"] <- "genotype" # Make this column header simpler 
```


# Load spatial data 
This code was pasted in from HumBlood_DataWrangling.Rmd to be able to seamlessly produce our sampling map. 
```{r}
# DOWNLOAD COUNTRY POLYGONS 
# Search country 3-letter ISO code: https://www.iso.org/obp/ui/#search
# Note: Chile's southern coastline makes plotting the outline near impossible; R  crashes every time 
# If you do want to plot outline, write straight to .pdf instead of plotting w/in RStudio
# Best approach seems to be to crop the extent of hte outline to remove Juan Fernandez Islands
# Then to crop and mask climate rasters to Peru and Chile
# THEN to merge these two rasters. 
peru <- raster::getData('GADM', country = "PER", level = 0) # download country shape  
chile <- raster::getData('GADM', country = "CHL", level = 0) 
extent(chile) # look at the spatial extent (lat, lon) of Chile; compare to map 
# Chile's extent goes way out into the Pacific because of Juan Fernandez Islands; get rid of these
extent_mainland <- extent(c(-76, -66.41472, -55.98403,-17.50755)) # Use map to pick a reasonable x min
chile <- crop(chile, extent_mainland) # this takes ~3-5 mins

# Download surrounding countries for visualization/map-making
countries <- c("BRA", "ARG", "ECU", "BOL", "VEN", "COL", "GUY", "SUR", "PRY", "URY") 
manycountries <- do.call("bind", lapply(countries, function(x) raster::getData('GADM', country=x, level=0)))

# Merge country polygons 
southamerica_countries <- merge(peru, chile, manycountries)


# READ IN ELEVATION RASTERS TO AVOID CUMBERSOME RE-PROCESSING
# Need to run BioClim data above to ensure that peru_chile is a raster brick otherwise you can't extract BioClim
#peru_chile_bioclim <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/peru_chile_bioclim.grd") # read in peru_chile BioClim data
peru_alt <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/peru_alt.grd") # elevation raster
chile_alt <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/chile_alt.grd") # elevation raster
surrounding_elevs <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/surrounding_elevs.grd") 
# surrounding South American country elevs
peru_chile_elev <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/peru_chile_alt.grd") 
  # Peru + Chile elev raster layer 
south_america_elevs <- raster("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/south_america_elevs.grd") # All South American country elevs combined


###### PROCESS SPATIAL DATA 

# Create a spatial data frame that has our community localities
# NAs in the data will create problems; e.g. you won't be able to make spatial data frame 
locality.coords <- SpatialPointsDataFrame(
                   matrix(c(final$lon, final$lat), ncol = 2),
                   data.frame(ID=1:nrow(final),
                   sampling.locality = final$locality,
                   sampling.elev = final$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )
```


-----


##  SAMPLING LOCALITY MAP 
Mapping tips here: https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html

# Define map/spatial extent (may or map not use this)
```{r, message=FALSE, warning=FALSE}
library(viridis)
library(RColorBrewer)

# CROP MAP EXTENT FOR BETTER VISUALIZATION 
# Wide version: 
# xmin = -90
# xmax = 41.7
# y min = -45.3
# y max = 0.8

# Zoomed version: 
# xmin = -86
# xmax = 47.4
# y min = -37
# y max = 0.8

# crop raster and country lines to a smaller box (hard to get right, requires a lot of tinkering)
# south_america_elevs_cropped = all elevation rasters combined 
# southamerica_cropped = all country polygons combined 
# These are perfect but fairly zoomed out to capture more of southern Chile 
#ex <- extent(c(-90, -41.7, -45.3, 0.8)) # These go: xmin (left), xmax (right), ymin (bottom), ymax (top)
# Zoomed in version: 
ex <- extent(c(-86, -47.4, -37, 0.8)) # These go: xmin (left), xmax (right), ymin (bottom), ymax (top)
south_america_elevs_cropped <- crop(south_america_elevs, ex)
extent(south_america_elevs_cropped)
southamerica_cropped <- crop(southamerica_countries, ex)

# Alternatively, instead of guessing, pull extent with: 
#find peru extent
# minx <- NULL
# maxx <- NULL
# miny <- NULL
# maxy <- NULL
# for(i in 1:68){ # Because Peru has 68 @polygons
#   minx[i] <- peru@polygons[[1]]@Polygons[[i]]@coords[,1] %>%min()
#   maxx[i] <- peru@polygons[[1]]@Polygons[[i]]@coords[,1] %>%max()
#   miny[i] <- peru@polygons[[1]]@Polygons[[i]]@coords[,2] %>%min()
#   maxy[i] <- peru@polygons[[1]]@Polygons[[i]]@coords[,2] %>%max()
# }
# minlong <- min(minx)
# maxlong <- max(maxx)
# minlat <- min(miny)
# maxlat <- max(maxy)
```


# MAP VERSION 1: Cropped and bounded by extend w/ lat and lon labeled
```{r}
# Peru and Chile sampling localities w/ rest of South America 
pdf("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/Peru_and_Chile_SamplingMap_WithSouthAmerica_Cropped_Outlines.pdf", useDingbats = F)
#plot(south_america_elevs_cropped, col = colorRampPalette(c("grey20","grey80"))(100), cex.axis=1.5, ext=ex)
plot(south_america_elevs_cropped, col=magma(200), cex.axis=1.5, ext=ex)
plot(manycountries, add=TRUE, border = "gray92", lwd = 0.05) # outlines surrounding countries; must be first to "layer"
#plot(manycountries, add=TRUE, border = "gray28", lwd = 0.5) # outlines surrounding countries; must be first to "layer"
plot(peru, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru 
plot(chile, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru 
#plot(locality.coords, add=TRUE, pch=19, cex=0.8, col="olivedrab1") # olivedrab1 points w/ no outline # doesn't look great
plot(locality.coords, add=TRUE, pch=21, cex=1.1, bg="olivedrab1") # pch=21 is circle w/ black outline
# olivedrab1 is electric and amazing; olivedrab2 *slightly* subtler and nice, but doesn't 'pop' quite as much
# olivedrab3 looks fantastic; yellow looks nice
addscalebar(plotepsg = 4326, widthhint=0.20, labelpadin = 0.08, label.cex = 0.8, label.col = "black", pos = "bottomleft")
#with(CommunitySpatial, text(CommunitySpatial,
#  labels=CommunitySpatial$ID, pos=4, cex=1.3))
dev.off()

# Played around a lot with aesthetics, namely: w/out country outlines, it's a little hard to orient in South America. 
# EBL thinks 2 colors to denote country lines is a little distracting
# I sorta like thin gray28 spiderweb lines for surrounding countries and thick white lines for Peru and Chile
# I also played around with ALL white outlines but thick for Peru and Chile and super thin for surrounding countries
# I think the best approach might be THICK white Peru + Chile outlines w/ slightly dulled bright gray spiderwebs
# that are much thinner; this makes it look like all the same color, but spiderwebs won't 'pop' as much to distract

# Notes on elevation color palettes, ranked: 
# magma is stunning, sophisticated
# cividis is stunning and lovely; equivalent topography resolution to inferno but subtler palette and nice 
# inferno looks great as well but doesn't pick up as much subtlety in topography as magma 
# Viridis is stunning but is what Sabrina used for Peru malaria paper; magma also picks up more detail in topography
# plasma is ok but looks a little 'cheaper' than magma, which is very sophisticated
# terrain.colors: base R option, looks cheap
# topo.colors: actually painful for the eyes 

# See allhum_blood_comp_CUT.Rmd for other map versions that I cut/didn't include here 
```


# MAP VERSION 2: Simpler map with full extent of Peru and Chile, no spatial extent cropping, lat/lon boxes will be removed
Points all one color 
```{r}
# "Naked" map of Peru and Chile, full extent. Cleaner and simpler, will look much nicer with our elev phylo range fig. 
# No constraining of extent. No outlines of surrounding countries. 
# ex.big <- extent(c(-86, -47.4, -47, 0.8)) # These go: xmin (left), xmax (right), ymin (bottom), ymax (top)

pdf("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/SamplingMap_PeruChileOnly_FullExtent_12-01-20.pdf", useDingbats = F)
#plot(peru_chile_elev, col=colorRampPalette(c("grey20","grey80"))(100), cex.axis=1.5) # for grayscale elev
plot(peru_chile_elev, col=magma(200), cex.axis=1.5) # removed ext=ex argument 
plot(chile, add=TRUE, border = "white", lwd = 0.000001) # Make outline incredibly faint to capture southern Chilean coastline
plot(peru, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru; must be second to get tiny portion of P-C border oulined
plot(locality.coords, add=TRUE, pch=21, cex=1.1, bg="turquoise") # olivedrab1 looks nice too; pch=21 is circle w/ black outline
# addscalebar(plotepsg=4326, widthhint=0.20, labelpadin=0.08, label.cex=0.8, label.col="black", pos="bottomleft")
# Removed scale bar becuase I think obvious geographic features will speak for themselves 
# text(x=-99.2, y=31.5, label="Texas", cex=0.75, font=2) # Peru label 
# text(x=-112.7, y=32.9, label="Arizona", cex=0.75, font=2) # Chile label
# Note, neither of those text label coords are correct - just samples of how to add text labels (not sure I want to)
dev.off()

pdf("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/SamplingMap_PeruChileOnly_Gray_12-01-20.pdf", useDingbats = F)
plot(peru_chile_elev, col=colorRampPalette(c("grey20","grey80"))(100), cex.axis=1.5) # for grayscale elev
#plot(peru_chile_elev, col=magma(200), cex.axis=1.5) # removed ext=ex argument 
plot(chile, add=TRUE, border = "white", lwd = 0.000001) # Make outline incredibly faint to capture southern Chilean coastline
plot(peru, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru; must be second to get tiny portion of P-C border oulined
plot(locality.coords, add=TRUE, pch=21, cex=1.1, bg="turquoise") # olivedrab1 looks nice too; pch=21 is circle w/ black outline
# addscalebar(plotepsg=4326, widthhint=0.20, labelpadin=0.08, label.cex=0.8, label.col="black", pos="bottomleft")
# Removed scale bar becuase I think obvious geographic features will speak for themselves 
# text(x=-99.2, y=31.5, label="Texas", cex=0.75, font=2) # Peru label 
# text(x=-112.7, y=32.9, label="Arizona", cex=0.75, font=2) # Chile label
# Note, neither of those text label coords are correct - just samples of how to add text labels (not sure I want to)
dev.off()
```


# MAP VERSION 3: Simpler map with full extent of Peru and Chile, no spatial extent cropping, POINTS COLORED BY ELEV BIN
Create spatial  points data frames binned by elevation
```{r}
# This would be way more straight forward with a nice loop or two, but...it was also super simple to execute this clunkier way.

# First subset the data by elevation: 
bin1 <- final[which(final$elev > 0 & final$elev < 1000), ] # Sea level to 1,000 m
bin2 <- final[which(final$elev > 1000 & final$elev < 2000), ] # 1,000 m to 2,000 m
bin3 <- final[which(final$elev > 2000 & final$elev < 3000), ] # 2,000 m to 3,000 m
bin4 <- final[which(final$elev > 3000 & final$elev < 4000), ] # 3,000 m to 4,000 m
bin5 <- final[which(final$elev > 4000 & final$elev < 5000), ] # 4,000 m to 5,000 m
sum(nrow(bin1)) + sum(nrow(bin2)) + sum(nrow(bin3)) + sum(nrow(bin4)) + sum(nrow(bin5)) # Good! = 1,157, total # rows in 'final'.

# Create spatial points data frames for each elevational bin 
# NAs in the data will create problems; e.g. you won't be able to make spatial data frame 
bin1.coords <- SpatialPointsDataFrame(
                   matrix(c(bin1$lon, bin1$lat), ncol = 2),
                   data.frame(ID=1:nrow(bin1),
                   sampling.locality = bin1$locality,
                   sampling.elev = bin1$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )

bin2.coords <- SpatialPointsDataFrame(
                   matrix(c(bin2$lon, bin2$lat), ncol = 2),
                   data.frame(ID=1:nrow(bin2),
                   sampling.locality = bin2$locality,
                   sampling.elev = bin2$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )

bin3.coords <- SpatialPointsDataFrame(
                   matrix(c(bin3$lon, bin3$lat), ncol = 2),
                   data.frame(ID=1:nrow(bin3),
                   sampling.locality = bin3$locality,
                   sampling.elev = bin3$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )

bin4.coords <- SpatialPointsDataFrame(
                   matrix(c(bin4$lon, bin4$lat), ncol = 2),
                   data.frame(ID=1:nrow(bin4),
                   sampling.locality = bin4$locality,
                   sampling.elev = bin4$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )

bin5.coords <- SpatialPointsDataFrame(
                   matrix(c(bin5$lon, bin5$lat), ncol = 2),
                   data.frame(ID=1:nrow(bin5),
                   sampling.locality = bin5$locality,
                   sampling.elev = bin5$elev),
                   proj4string=CRS("+init=epsg:4326")
                   )
```

Map. 
```{r}
pdf("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/SamplingMap_PeruChileOnly_ColorByElev.pdf", useDingbats = F)
#plot(peru_chile_elev, col=colorRampPalette(c("grey20","grey80"))(100), cex.axis=1.5) # for grayscale elev
plot(peru_chile_elev, col=magma(200), cex.axis=1.5) # removed ext=ex argument 
plot(peru, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru 
plot(chile, add=TRUE, border = "white", lwd = 1.5) # This outlines Peru 
plot(bin1.coords, add=TRUE, pch=21, cex=1.1, bg="olivedrab1") # pch=21 is circle w/ black outline
plot(bin2.coords, add=TRUE, pch=21, cex=1.1, bg="red") # pch=21 is circle w/ black outline
plot(bin3.coords, add=TRUE, pch=21, cex=1.1, bg="turquoise") # pch=21 is circle w/ black outline
plot(bin4.coords, add=TRUE, pch=21, cex=1.1, bg="white") # pch=21 is circle w/ black outline
plot(bin5.coords, add=TRUE, pch=21, cex=1.1, bg="darkorchid") # pch=21 is circle w/ black outline
#addscalebar(plotepsg = 4326, widthhint=0.20, labelpadin = 0.08, label.cex = 0.8, label.col = "black", pos = "bottomleft")
#with(CommunitySpatial, text(CommunitySpatial,
#  labels=CommunitySpatial$ID, pos=4, cex=1.3))
dev.off()

# Colors are awful  but are trial colors
# Only thing about this is that now I almost have *too* much information about elevation: map is shaded by elev AND sampling 
# points are colored by elev - it's a little much. 
# The other issue is that many overlapping points obscure interesting sampling across elevations, so the colors don't convey as 
# much info as I'd wanted. And, as I discovered for the OLWA-BHCO project, there is no way to jitter a spatial points data frame
# (see that script for how I attempted to introduce jitter, though that workaround wasn't 100% satisfying)
# I think I vote to leave sampling across elevs as all one color. 
```


# MAP VERSION 4: all of SA, no cropping, non-Chile, non-Peru countries faded 
```{r}
# Peru and Chile sampling localities w/ rest of South America 
pdf("/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/SamplingMap_AllSA_PeruChileHighlight.pdf", useDingbats = F)
#plot(south_america_elevs, col=colorRampPalette(c("grey20","grey80"))(100), cex.axis=1.5) # remove extent 
plot(south_america_elevs, col=magma(200), cex.axis=1.5) # Remove ext=ex
plot(manycountries, add=TRUE, border = "gray92", lwd = 0.05) # outlines surrounding countries; must be first to "layer"
#plot(peru_chile_elev, col=magma(200), cex.axis=1.5) # removed ext=ex argument 
plot(chile, add=TRUE, border = "white", lwd = 0.000001) # Make outline incredibly faint to capture southern Chilean coastline
plot(peru, add=TRUE, border = "white", lwd = 0.05) # This outlines Peru; must be second to get tiny portion of P-C border oulined
plot(locality.coords, add=TRUE, pch=21, cex=1.1, bg="turquoise") # olivedrab1 looks nice too; pch=21 is circle w/ black outline
# addscalebar(plotepsg=4326, widthhint=0.20, labelpadin=0.08, label.cex=0.8, label.col="black", pos="bottomleft")
# Removed scale bar becuase I think obvious geographic features will speak for themselves 
# text(x=-99.2, y=31.5, label="Texas", cex=0.75, font=2) # Peru label 
# text(x=-112.7, y=32.9, label="Arizona", cex=0.75, font=2) # Chile label
# Note, neither of those text label coords are correct - just samples of how to add text labels (not sure I want to)
dev.off()

# This doesn't seem to want to work; I think I'd need to merge an elev layer for just surrounding countries AND THEN plot 
# just Peru and Chile (I suspect R doesn't want to make the overlap work)
```




------

## ELEV RANGES OF EACH SPECIES IN THE DATASET FOR ELEV RANGE PHYLO FIG

# For elevational range phylogeny figure: Ceate a species mean dataset, wrangle into workable format for Illustrator figure
Note: this script should be cleaned up and probably moved for my plots & figs .Rmd. Still a working chunk, in here for now. 
```{r, echo=FALSE,  message=FALSE, warning=FALSE}
# Figure out why there are NaNs! In at least a few cases it comes from only 1 individual per species
# drop species with fewer than 2? 

# species mean data
species.means <- final %>% group_by(species) %>%
                                  dplyr::summarize(
                                    mean_mass = mean(mass, na.rm = TRUE),
                                    mean_hb = mean(hb, na.rm=TRUE),
                                    mean_hct = mean(hct, na.rm=TRUE),
                                    mean_trbc = mean(trbc, na.rm=TRUE),
                                    mean_mcv = mean(mcv, na.rm=TRUE),
                                    mean_mch = mean(mch, na.rm=TRUE),
                                    mean_mchc = mean(mchc, na.rm=TRUE),
                                    mean_elev = mean(elev, na.rm=TRUE),
                                    elev_min = mean(elev_min, na.rm=TRUE), # Mean will just be elev_min cause all same 
                                    elev_max = mean(elev_max, na.rm=TRUE), # Mean will just be elev_max cause all same 
                                    range = mean(elev_range, na.rm=TRUE),  # Mean will just be elev_range cause all same 
                                    count=n())                              #Gives a count of total samples/species

# Assign species to clades 
species.means$Clade <- NA # Instantiate new col; capitalize this for easy and nice plot formatting

# add clade labels for 9 hummingbird clades

# EMERALDS
species.means$Clade[species.means$species=="Amazilia amazilia" | 
           species.means$species=="Amazilia chionogaster" | 
           species.means$species=="Amazilia franciae" | 
           species.means$species=="Amazilia lactea" | 
           species.means$species=="Amazilia viridicauda" | 
           species.means$species=="Chrysuronia oenone" | 
           species.means$species=="Taphrospilus hypostictus" | 
           species.means$species=="Thalurania furcata" | 
           species.means$species=="Campylopterus largipennis" | 
           species.means$species=="Campylopterus villaviscensio" | 
           species.means$species=="Leucippus taczanowskii" | 
           species.means$species=="Klais guimeti"] <- paste("Emerald")

# BEES 
species.means$Clade[species.means$species=="Calliphlox amethystina" | 
           species.means$species=="Thaumastura cora" | 
           species.means$species=="Chaetocercus mulsant" |
           species.means$species=="Myrmia micrura" |
           species.means$species=="Myrtis fanny" |
           species.means$species=="Rhodopis vesper"] <- paste("Bee") 

# MOUNTAIN GEMS 
species.means$Clade[species.means$species=="Heliomaster longirostris"] <- paste("Mountain-gem")

# PATAGONA 
species.means$Clade[species.means$species=="Patagona gigas"] <- paste("Patagona") 

# COQUETTES (Andean clade)
species.means$Clade[species.means$species=="Phlogophilus harterti" | 
           species.means$species=="Adelomyia melanogenys" | 
           species.means$species=="Aglaiocercus kingii" | 
           species.means$species=="Chalcostigma herrani" | 
           species.means$species=="Chalcostigma ruficeps" | 
           species.means$species=="Chalcostigma stanleyi" | 
           species.means$species=="Heliangelus amethysticollis" | 
           species.means$species=="Heliangelus micraster" | 
           species.means$species=="Heliangelus viola" | 
           species.means$species=="Metallura eupogon" | 
           species.means$species=="Metallura phoebe" | 
           species.means$species=="Metallura tyrianthina" | 
           species.means$species=="Oreotrochilus estella" | 
           species.means$species=="Oreotrochilus leucopleurus" | 
           species.means$species=="Oreotrochilus melanogaster" | 
           species.means$species=="Polyonymus caroli" | 
           species.means$species=="Sephanoides sephaniodes" | 
           species.means$species=="Oreonympha nobilis" |
           species.means$species=="Lesbia nuna" |
           species.means$species=="Lesbia victoriae"] <- paste("Coquette")

# BRILLIANTS (Andean clade)
species.means$Clade[species.means$species=="Aglaeactis castelnaudii" | 
           species.means$species=="Aglaeactis cupripennis" | 
           species.means$species=="Boissonneaua matthewsii" | 
           species.means$species=="Coeligena coeligena" | 
           species.means$species=="Coeligena iris" | 
           species.means$species=="Coeligena lutetiae" | 
           species.means$species=="Coeligena torquata" | 
           species.means$species=="Coeligena violifer" | 
           species.means$species=="Ensifera ensifera" | 
           species.means$species=="Eriocnemis aline" | 
           species.means$species=="Eriocnemis luciani" | 
           species.means$species=="Eriocnemis vestita" | 
           species.means$species=="Haplophaedia aureliae" | 
           species.means$species=="Heliodoxa aurescens" | 
           species.means$species=="Heliodoxa leadbeateri" | 
           species.means$species=="Heliodoxa rubinoides" | 
           species.means$species=="Lafresnaya lafresnayi" | 
           species.means$species=="Ocreatus underwoodii" | 
           species.means$species=="Pterophanes cyanopterus"] <- paste("Brilliant")

# MANGOS
species.means$Clade[species.means$species=="Anthracothorax nigricollis" | 
           species.means$species=="Colibri coruscans" | 
           species.means$species=="Colibri cyanotus" |  # Remember you changed Colibri thalassinus to cyanotus above 
           species.means$species=="Doryfera ludovicae" |
           species.means$species=="Schistes geoffroyi"] <- paste("Mango")

# HERMITS 
species.means$Clade[species.means$species=="Eutoxeres aquila" | 
           species.means$species=="Eutoxeres condamini" | 
           species.means$species=="Glaucis hirsutus" | 
           species.means$species=="Phaethornis atrimentalis" | 
           species.means$species=="Phaethornis guy" | 
           species.means$species=="Phaethornis hispidus" | 
           species.means$species=="Phaethornis malaris" | 
           species.means$species=="Phaethornis philippii" | 
           species.means$species=="Phaethornis ruber" | 
           species.means$species=="Phaethornis stuarti" | 
           species.means$species=="Phaethornis syrmatophorus" | 
           species.means$species=="Threnetes leucurus"] <- paste("Hermit")

# TOPAZES AND JACOBINS 
species.means$Clade[species.means$species=="Florisuga mellivora"] <- paste("Topaz") 


# Create order based on phylogeny branch order (for elev_range plotting)
species.means$phylo_order <- NA # Instantiate new col; capitalize this for easy and nice plot formatting

species.means$phylo_order[species.means$species=="Phlogophilus harterti"] <- paste(.1) # Weird decimals only way to keep order
species.means$phylo_order[species.means$species=="Oreotrochilus leucopleurus"] <- paste(.2)
species.means$phylo_order[species.means$species=="Oreotrochilus estella"] <- paste(.3)
species.means$phylo_order[species.means$species=="Oreotrochilus melanogaster"] <- paste(.4)
species.means$phylo_order[species.means$species=="Polyonymus caroli"] <- paste(.5)
species.means$phylo_order[species.means$species=="Chalcostigma herrani"] <- paste(.6)
species.means$phylo_order[species.means$species=="Chalcostigma ruficeps"] <- paste(.7)
species.means$phylo_order[species.means$species=="Oreonympha nobilis"] <- paste(.8)
species.means$phylo_order[species.means$species=="Chalcostigma stanleyi"] <- paste(.9)
species.means$phylo_order[species.means$species=="Metallura eupogon"] <- paste(10)
species.means$phylo_order[species.means$species=="Metallura tyrianthina"] <- paste(11)
species.means$phylo_order[species.means$species=="Metallura phoebe"] <- paste(12)
species.means$phylo_order[species.means$species=="Lesbia nuna"] <- paste(13)
species.means$phylo_order[species.means$species=="Lesbia victoriae"] <- paste(14)
species.means$phylo_order[species.means$species=="Adelomyia melanogenys"] <- paste(15)
species.means$phylo_order[species.means$species=="Aglaiocercus kingii"] <- paste(16)
species.means$phylo_order[species.means$species=="Heliangelus amethysticollis"] <- paste(17)
species.means$phylo_order[species.means$species=="Heliangelus micraster"] <- paste(18)
species.means$phylo_order[species.means$species=="Heliangelus viola"] <- paste(19)
species.means$phylo_order[species.means$species=="Sephanoides sephaniodes"] <- paste(20) # Coquettes  

species.means$phylo_order[species.means$species=="Lafresnaya lafresnayi"] <- paste(21)
species.means$phylo_order[species.means$species=="Aglaeactis castelnaudii"] <- paste(22)
species.means$phylo_order[species.means$species=="Aglaeactis cupripennis"] <- paste(23)
species.means$phylo_order[species.means$species=="Heliodoxa leadbeateri"] <- paste(24)
species.means$phylo_order[species.means$species=="Heliodoxa rubinoides"] <- paste(25)
species.means$phylo_order[species.means$species=="Heliodoxa aurescens"] <- paste(26)
species.means$phylo_order[species.means$species=="Boissonneaua matthewsii"] <- paste(27)
species.means$phylo_order[species.means$species=="Ocreatus underwoodii"] <- paste(28)
species.means$phylo_order[species.means$species=="Pterophanes cyanopterus"] <- paste(29)
species.means$phylo_order[species.means$species=="Ensifera ensifera"] <- paste(30)
species.means$phylo_order[species.means$species=="Coeligena coeligena"] <- paste(31)
species.means$phylo_order[species.means$species=="Coeligena violifer"] <- paste(32)
species.means$phylo_order[species.means$species=="Coeligena lutetiae"] <- paste(33)
species.means$phylo_order[species.means$species=="Coeligena iris"] <- paste(34)
species.means$phylo_order[species.means$species=="Coeligena torquata"] <- paste(35)
species.means$phylo_order[species.means$species=="Eriocnemis vestita"] <- paste(36)
species.means$phylo_order[species.means$species=="Eriocnemis luciani"] <- paste(37)
species.means$phylo_order[species.means$species=="Eriocnemis aline"] <- paste(38)
species.means$phylo_order[species.means$species=="Haplophaedia aureliae"] <- paste(39) # Brilliants

species.means$phylo_order[species.means$species=="Patagona gigas"] <- paste(40) # Patagona

species.means$phylo_order[species.means$species=="Calliphlox amethystina"] <- paste(41)
species.means$phylo_order[species.means$species=="Rhodopis vesper"] <- paste(42) 
species.means$phylo_order[species.means$species=="Myrtis fanny"] <- paste(43) 
species.means$phylo_order[species.means$species=="Thaumastura cora"] <- paste(44) 
species.means$phylo_order[species.means$species=="Myrmia micrura"] <- paste(45) 
species.means$phylo_order[species.means$species=="Chaetocercus mulsant"] <- paste(46) # Bees 

species.means$phylo_order[species.means$species=="Heliomaster longirostris"] <- paste(47) # Mountain-gems 

species.means$phylo_order[species.means$species=="Campylopterus villaviscensio"] <- paste(48) 
species.means$phylo_order[species.means$species=="Campylopterus largipennis"] <- paste(49) 
species.means$phylo_order[species.means$species=="Klais guimeti"] <- paste(50) 
species.means$phylo_order[species.means$species=="Amazilia lactea"] <- paste(51) 
species.means$phylo_order[species.means$species=="Amazilia viridicauda"] <- paste(52) 
species.means$phylo_order[species.means$species=="Amazilia chionogaster"] <- paste(53) 
species.means$phylo_order[species.means$species=="Chrysuronia oenone"] <- paste(54) 
species.means$phylo_order[species.means$species=="Amazilia franciae"] <- paste(55) 
species.means$phylo_order[species.means$species=="Amazilia amazilia"] <- paste(56) 
species.means$phylo_order[species.means$species=="Leucippus taczanowskii"] <- paste(57) 
species.means$phylo_order[species.means$species=="Taphrospilus hypostictus"] <- paste(58) 
species.means$phylo_order[species.means$species=="Thalurania furcata"] <- paste(59) # Emeralds

species.means$phylo_order[species.means$species=="Anthracothorax nigricollis"] <- paste(60) 
species.means$phylo_order[species.means$species=="Doryfera ludovicae"] <- paste(61) 
species.means$phylo_order[species.means$species=="Colibri cyanotus"] <- paste(62) 
species.means$phylo_order[species.means$species=="Colibri coruscans"] <- paste(63) 
species.means$phylo_order[species.means$species=="Schistes geoffroyi"] <- paste(64) # Mangos

species.means$phylo_order[species.means$species=="Florisuga mellivora"] <- paste(65) # Topazes

species.means$phylo_order[species.means$species=="Eutoxeres condamini"] <- paste(66) 
species.means$phylo_order[species.means$species=="Eutoxeres aquila"] <- paste(67) 
species.means$phylo_order[species.means$species=="Glaucis hirsutus"] <- paste(68) 
species.means$phylo_order[species.means$species=="Threnetes leucurus"] <- paste(69) 
species.means$phylo_order[species.means$species=="Phaethornis guy"] <- paste(70) 
species.means$phylo_order[species.means$species=="Phaethornis malaris"] <- paste(71) 
species.means$phylo_order[species.means$species=="Phaethornis syrmatophorus"] <- paste(72) 
species.means$phylo_order[species.means$species=="Phaethornis hispidus"] <- paste(73)
species.means$phylo_order[species.means$species=="Phaethornis philippii"] <- paste(74) 
species.means$phylo_order[species.means$species=="Phaethornis stuarti"] <- paste(75) 
species.means$phylo_order[species.means$species=="Phaethornis atrimentalis"] <- paste(76) 
species.means$phylo_order[species.means$species=="Phaethornis ruber"] <- paste(77) # Hermits

# Consider adding elev_position, BioClim variables, temp and precip PCAs, other stuff
# If you do want to use this and color by clades, need to manually add in clades 

# Calculate elevation range midpoints and midpoint offsets: 
species.means$elevmidpt <- species.means$range/2 # Make variable for elevational midpoint for each species 
species.means$elevmidpt_offset <- species.means$elevmidpt + species.means$elev_min # IMPORTANT!!!!
# Because midpoints will be plotted with correct numbers but on full elev x-axis scale, midpoints don't align properly w/in 
# their associated elev ranges (i.e. if range = 1000-2000, midpoint=500, but point will be plotted AT 500 instead of 1,500)
# To correct for this, I'll add the elev_min "offset" to each midpoint, which makes its starting point the elev_min #
# After testing this out, thins look correct: All elev midpoints plot accurately at their midpoints within their elev range (!)

write.csv(species.means, "/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/AllHummingbird_SpeciesMeanBloodData_03-01-21.csv")


# Now make copy of 'final' dataset that you can finagle to get offset collection elevations to represent sampling: 
sampling <- final 

# Add phylo order to this big samping dataset
sampling$phylo_order <- NA # Instantiate new col; capitalize this for easy and nice plot formatting

sampling$phylo_order[sampling$species=="Phlogophilus harterti"] <- paste(.1) # Weird decimals only way to keep order
sampling$phylo_order[sampling$species=="Oreotrochilus leucopleurus"] <- paste(.2)
sampling$phylo_order[sampling$species=="Oreotrochilus estella"] <- paste(.3)
sampling$phylo_order[sampling$species=="Oreotrochilus melanogaster"] <- paste(.4)
sampling$phylo_order[sampling$species=="Polyonymus caroli"] <- paste(.5)
sampling$phylo_order[sampling$species=="Chalcostigma herrani"] <- paste(.6)
sampling$phylo_order[sampling$species=="Chalcostigma ruficeps"] <- paste(.7)
sampling$phylo_order[sampling$species=="Oreonympha nobilis"] <- paste(.8)
sampling$phylo_order[sampling$species=="Chalcostigma stanleyi"] <- paste(.9)
sampling$phylo_order[sampling$species=="Metallura eupogon"] <- paste(10)
sampling$phylo_order[sampling$species=="Metallura tyrianthina"] <- paste(11)
sampling$phylo_order[sampling$species=="Metallura phoebe"] <- paste(12)
sampling$phylo_order[sampling$species=="Lesbia nuna"] <- paste(13)
sampling$phylo_order[sampling$species=="Lesbia victoriae"] <- paste(14)
sampling$phylo_order[sampling$species=="Adelomyia melanogenys"] <- paste(15)
sampling$phylo_order[sampling$species=="Aglaiocercus kingii"] <- paste(16)
sampling$phylo_order[sampling$species=="Heliangelus amethysticollis"] <- paste(17)
sampling$phylo_order[sampling$species=="Heliangelus micraster"] <- paste(18)
sampling$phylo_order[sampling$species=="Heliangelus viola"] <- paste(19)
sampling$phylo_order[sampling$species=="Sephanoides sephaniodes"] <- paste(20) # Coquettes  

sampling$phylo_order[sampling$species=="Lafresnaya lafresnayi"] <- paste(21)
sampling$phylo_order[sampling$species=="Aglaeactis castelnaudii"] <- paste(22)
sampling$phylo_order[sampling$species=="Aglaeactis cupripennis"] <- paste(23)
sampling$phylo_order[sampling$species=="Heliodoxa leadbeateri"] <- paste(24)
sampling$phylo_order[sampling$species=="Heliodoxa rubinoides"] <- paste(25)
sampling$phylo_order[sampling$species=="Heliodoxa aurescens"] <- paste(26)
sampling$phylo_order[sampling$species=="Boissonneaua matthewsii"] <- paste(27)
sampling$phylo_order[sampling$species=="Ocreatus underwoodii"] <- paste(28)
sampling$phylo_order[sampling$species=="Pterophanes cyanopterus"] <- paste(29)
sampling$phylo_order[sampling$species=="Ensifera ensifera"] <- paste(30)
sampling$phylo_order[sampling$species=="Coeligena coeligena"] <- paste(31)
sampling$phylo_order[sampling$species=="Coeligena violifer"] <- paste(32)
sampling$phylo_order[sampling$species=="Coeligena lutetiae"] <- paste(33)
sampling$phylo_order[sampling$species=="Coeligena iris"] <- paste(34)
sampling$phylo_order[sampling$species=="Coeligena torquata"] <- paste(35)
sampling$phylo_order[sampling$species=="Eriocnemis vestita"] <- paste(36)
sampling$phylo_order[sampling$species=="Eriocnemis luciani"] <- paste(37)
sampling$phylo_order[sampling$species=="Eriocnemis aline"] <- paste(38)
sampling$phylo_order[sampling$species=="Haplophaedia aureliae"] <- paste(39) # Brilliants

sampling$phylo_order[sampling$species=="Patagona gigas"] <- paste(40) # Patagona

sampling$phylo_order[sampling$species=="Calliphlox amethystina"] <- paste(41)
sampling$phylo_order[sampling$species=="Rhodopis vesper"] <- paste(42) 
sampling$phylo_order[sampling$species=="Myrtis fanny"] <- paste(43) 
sampling$phylo_order[sampling$species=="Thaumastura cora"] <- paste(44) 
sampling$phylo_order[sampling$species=="Myrmia micrura"] <- paste(45) 
sampling$phylo_order[sampling$species=="Chaetocercus mulsant"] <- paste(46) # Bees 

sampling$phylo_order[sampling$species=="Heliomaster longirostris"] <- paste(47) # Mountain-gems 

sampling$phylo_order[sampling$species=="Campylopterus villaviscensio"] <- paste(48) 
sampling$phylo_order[sampling$species=="Campylopterus largipennis"] <- paste(49) 
sampling$phylo_order[sampling$species=="Klais guimeti"] <- paste(50) 
sampling$phylo_order[sampling$species=="Amazilia lactea"] <- paste(51) 
sampling$phylo_order[sampling$species=="Amazilia viridicauda"] <- paste(52) 
sampling$phylo_order[sampling$species=="Amazilia chionogaster"] <- paste(53) 
sampling$phylo_order[sampling$species=="Chrysuronia oenone"] <- paste(54) 
sampling$phylo_order[sampling$species=="Amazilia franciae"] <- paste(55) 
sampling$phylo_order[sampling$species=="Amazilia amazilia"] <- paste(56) 
sampling$phylo_order[sampling$species=="Leucippus taczanowskii"] <- paste(57) 
sampling$phylo_order[sampling$species=="Taphrospilus hypostictus"] <- paste(58) 
sampling$phylo_order[sampling$species=="Thalurania furcata"] <- paste(59) # Emeralds

sampling$phylo_order[sampling$species=="Anthracothorax nigricollis"] <- paste(60) 
sampling$phylo_order[sampling$species=="Doryfera ludovicae"] <- paste(61) 
sampling$phylo_order[sampling$species=="Colibri cyanotus"] <- paste(62) 
sampling$phylo_order[sampling$species=="Colibri coruscans"] <- paste(63) 
sampling$phylo_order[sampling$species=="Schistes geoffroyi"] <- paste(64) # Mangos

sampling$phylo_order[sampling$species=="Florisuga mellivora"] <- paste(65) # Topazes

sampling$phylo_order[sampling$species=="Eutoxeres condamini"] <- paste(66) 
sampling$phylo_order[sampling$species=="Eutoxeres aquila"] <- paste(67) 
sampling$phylo_order[sampling$species=="Glaucis hirsutus"] <- paste(68) 
sampling$phylo_order[sampling$species=="Threnetes leucurus"] <- paste(69) 
sampling$phylo_order[sampling$species=="Phaethornis guy"] <- paste(70) 
sampling$phylo_order[sampling$species=="Phaethornis malaris"] <- paste(71) 
sampling$phylo_order[sampling$species=="Phaethornis syrmatophorus"] <- paste(72) 
sampling$phylo_order[sampling$species=="Phaethornis hispidus"] <- paste(73)
sampling$phylo_order[sampling$species=="Phaethornis philippii"] <- paste(74) 
sampling$phylo_order[sampling$species=="Phaethornis stuarti"] <- paste(75) 
sampling$phylo_order[sampling$species=="Phaethornis atrimentalis"] <- paste(76) 
sampling$phylo_order[sampling$species=="Phaethornis ruber"] <- paste(77) # Hermits

#### playing around, this needs to go in plots and figs script

#sort by complete ENSM magnitude (descending)
species.means$phylo_order <- as.numeric(species.means$phylo_order) # Need to make this numeric
sampling$phylo_order <- as.numeric(sampling$phylo_order) # Need to make this numeric
# species.means$range <- as.numeric(species.means$range)

# Species elevational ranges in order of phylogeny 
p1 <- ggplot(data=species.means, aes(y=range, x=reorder(phylo_order, -phylo_order))) + # Add fill=Clade to color by clade 
            # x=reorder is saying "reorder common_name on x-axis by magnitude of elev shift in DESCENDING"
      # geom_bar(stat="identity", position=position_dodge(), width=0.2) + # trick: don't plot these! 
     # geom_line(aes(ymin=elev_min, ymax=elev_max)) +
      geom_errorbar(aes(ymin=elev_min, ymax=elev_max), width=0.5) + # Specifies exact elev range; width controls error bar caps
      geom_point(data=sampling, position=position_jitter(width=0.08, height=0.5), # SAMPLING POINTS, jittered 
                 # WIDTH=height and HEIGHT=width w/ coordflip
                 aes(y=elev, x=reorder(phylo_order, -phylo_order)), 
                 shape=16, color="gray28", alpha=0.5, size=1.0) + # or gray28 for a bit lighter? 
      geom_point(aes(y=elevmidpt_offset, x=reorder(phylo_order, -phylo_order)), # ELEVATION MIDPOINT OF RANGE 
                 shape=18, color="firebrick1", size=1.4) +
      coord_flip() + # This flips x and y axes
      scale_y_continuous(position="right") + # Because of coord flip, "right" moves x-axis to top of plot 
      theme(axis.text.x=element_text(angle=0, hjust=0.5),
           panel.grid.major=element_blank(), 
           panel.grid.minor=element_blank(),
           panel.background = element_blank()) +
      labs(title="",x="", y = "Elevational Range (m)") + # y = species in phylo order 
      theme(plot.title = element_text(face="bold")) + # This makes panel header bold 
      # This is good for labeling figure panels! Avoids having to manually toy w/ hjust and vjust
      theme(axis.text.y=element_text(size=8), axis.text.x=element_text(size=10), axis.title=element_text(size=8))
print(p1)
ggsave(p1, filename="/Users/Jessie/Dropbox (MSBbirds)/Rdirectory/ComparativeHummingbirdBlood/AllSpecies_ElevRange_PhylogenyOrder_ForDoctoringInIllustrator_WholeRange_03-01-21.pdf", height=6.35, width=2.8, units="in")
# Same units as phylogeny for easy wrangling? 

# NOTE: 
# I MADE THIS REALLY EASY FOR MYSELF! Just write out this pdf, open in Illustrator, remove clipping mask, and paste into 
# elev range layer - no resizing necessary.
# Only modifications: Make elev range line widths 0.5 and make top tick marks black (vs. dark gray)  

#####
# TRIAL AND ERROR NOTES ON PLOTTING ELEV RANGES: 
# geom_pointrante() plots the midpoint of your line segment IF the ymin and ymax are -/+ some number from the y variable
# ymin and ymax are meant to represent standard deviation, so must be manipulating y variable somehow
# If you do like I need to and plot ymin and ymax and entirely separate variables, the "midpoint" of geom_pointrange is off 
# Example of geom_pointrange working correctly: 
# ggplot(data=species.means) +
#   aes(
#    x = phylo_order, # reorder(phylo_order, -phylo_order),
#    y = range,
#    ymin = range-500, # BUT, if I specify ymin=elev_min and ymax=elev_max, points are all wonky 
#    ymax = range+500
#   ) +
#   geom_pointrange()

# Help on coord_flip and moving axis positions after coord_flip:
# https://stackoverflow.com/questions/63863398/in-ggplot2-how-can-i-move-the-x-axis-on-top-in-this-case-then-rotate-the-axes-w
# change geom_bar style; make thin w/ caps at ends

```

Helpful data summarizing tips: http://kbroman.org/datacarpentry_R_2016-06-01/03-dplyr.html

